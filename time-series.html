
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Time Series &#8212; Coding for Economists</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-9FZQCPFXZJ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-9FZQCPFXZJ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-9FZQCPFXZJ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'time-series';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="canonical" href="https://aeturrell.github.io/coding-for-economists/time-series.html" />
    <link rel="icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Forecasting Exercises" href="time-fcasts-env.html" />
    <link rel="prev" title="Introduction to Time" href="time-intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/smith_lovelace.png" class="logo__image only-light" alt="Coding for Economists - Home"/>
    <script>document.write(`<img src="_static/smith_lovelace.png" class="logo__image only-dark" alt="Coding for Economists - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="code-preliminaries.html">Preliminaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-basics.html">Coding Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow-basics.html">Workflow Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-where.html">Writing Code</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essential Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="data-analysis-quickstart.html">Data Analysis Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-intro.html">Working with Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-transformation.html">Data Transformation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-read-and-write.html">Reading and Writing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-numbers.html">Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-categorical.html">Categorical Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-spreadsheets.html">Spreadsheets</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essential Coding</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="code-best-practice.html">Code in Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-advanced.html">Coding</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-advcd-best-practice.html">Shortcuts to Better Coding</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essential Data Visualisation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="vis-intro.html">Intro to Data Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-letsplot.html">Easy Data Visualisation for Tidy Data with <strong>Lets-Plot</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-matplotlib.html">Powerful Data Visualisation with <strong>Matplotlib</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-common-plots-one.html">Common Plots I</a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-common-plots-two.html">Common Plots II</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essential Workflow</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="auto-research-outputs.html">Automating Research Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrkflow-markdown.html">Markdown</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrkflow-command-line.html">The Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrkflow-version-control.html">Version Control</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Econometrics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="econmt-probability-random.html">Probability and Random Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-regression.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-generalised-models.html">Generalised regression models</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-diagnostics.html">Regression diagnostics and visualisations</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-causal-inference.html">Causal Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-bayesian.html">Bayesian Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="econmt-bayes-bambi.html">Bayesian Inference Made Easier</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="data-boolean.html">Boolean Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-joining-data.html">Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-missing-values.html">Missing Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-exploratory-analysis.html">Exploratory Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-extraction.html">Getting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-advanced.html"><strong>pandas</strong> alternatives, validation, and orchestration</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-sharing.html">Sharing Data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Coding</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="code-further-advanced.html">Advanced Coding</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Visualisation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="vis-narrative.html">Narrative Data Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-tables.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-dashboards.html">Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-animation.html">Animation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Workflow</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="wrkflow-quarto.html">Combining Code and Text in Quarto Markdown</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrkflow-environments.html">Virtual Code Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrkflow-rap.html">Reproducible Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Time</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="time-intro.html">Introduction to Time</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Time Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="time-fcasts-env.html">Forecasting Exercises</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Text Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="text-intro.html">Introduction to Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="text-regex.html">Regular Expressions, aka regex</a></li>
<li class="toctree-l1"><a class="reference internal" href="text-nlp.html">Natural Language Processing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Machine Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ml-intro.html">Introduction to Machine Learning and AI</a></li>
<li class="toctree-l1"><a class="reference internal" href="ml-sup.html">Supervised Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="ml-data.html">Data for Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="ml-unsup.html">Unsupervised Machine Learning</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Geospatial</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="geo-intro.html">Intro to Geo-Spatial Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="geo-vis.html">Geo-Spatial Visualisation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mathematics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="maths-abstract.html">Abstract Mathematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="maths-numerical.html">Numerical Mathematics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Craft</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="craft-intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-search.html">Putting the Search in Research</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-generating-ideas.html">Generating and Accepting Research Ideas</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-writing-papers.html">Writing Papers</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-research-blogs.html">Research Blog Posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-referee.html">Writing Referee Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-technical-reports.html">Writing Technical Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="craft-extended-abstracts.html">Extended Abstracts</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Data Visualisation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="vis-plotnine.html">Data Visualisation using the Grammar of Graphics with <strong>Plotnine</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="vis-seaborn.html">Data Visualisation with <strong>Seaborn</strong></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Coming from ...</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="coming-from-stata.html">Coming from Stata</a></li>
<li class="toctree-l1"><a class="reference internal" href="coming-from-matlab.html">Coming from Matlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="coming-from-r.html">Coming from R</a></li>
<li class="toctree-l1"><a class="reference internal" href="coming-from-excel.html">Coming from Excel</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">End Matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="zreferences.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/aeturrell/coding-for-economists/blob/main/time-series.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/aeturrell/coding-for-economists" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/aeturrell/coding-for-economists/issues/new?title=Issue%20on%20page%20%2Ftime-series.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/time-series.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Time Series</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-time-series-with-pandas">Introducing Time Series with <strong>pandas</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-and-using-time-series">Creating and Using Time Series</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#datetime-offsets">Datetime Offsets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-dt-accessor">The <code class="docutils literal notranslate"><span class="pre">.dt</span></code> accessor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-datetime-index-and-setting-the-frequency">Creating a datetime index and setting the frequency</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-quick-time-series-plots">Making Quick Time Series Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling-rolling-and-shifting">Resampling, Rolling, and Shifting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling">Resampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rolling-window-functions">Rolling Window Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shifting">Shifting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correlations">Correlations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autocorrelation">Autocorrelation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#correlations-with-other-series">Correlations with Other Series</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transformations">Transformations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-transformations">Mathematical Transformations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-box-cox-transform">The Box-Cox Transform</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjusting-for-inflation">Adjusting for Inflation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature Engineering</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stationarity-and-unit-root-testing">Stationarity and Unit Root Testing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#augmented-dickey-fuller-test">Augmented Dickey-Fuller Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kpss-testing">KPSS Testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-unit-root-tests">Other Unit Root Tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality">Seasonality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classical-seasonal-decomposition">Classical Seasonal Decomposition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exponential-smoothing">Exponential Smoothing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stl-or-seasonal-trend-decomposition-based-on-loess">STL, or Seasonal-Trend Decomposition Based on Loess</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unobserved-components-model-aka-structural-time-series-model">Unobserved Components Model, aka Structural Time Series Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-seasonal-adjustment-approaches">Other Seasonal Adjustment Approaches</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#holidays">Holidays</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-and-holiday-adjustment">Seasonal and Holiday Adjustment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#granger-causality">Granger Causality</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#breaks-and-changepoint-detection">Breaks and Changepoint Detection</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="time-series">
<span id="id1"></span><h1>Time Series<a class="headerlink" href="#time-series" title="Link to this heading">#</a></h1>
<p>In this chapter, we’ll look at time series. If you haven’t yet looked at the two sections on <strong>pandas</strong>, the <a class="reference internal" href="data-analysis-quickstart.html#data-quickstart"><span class="std std-ref">Data Quickstart</span></a> and <a class="reference internal" href="data-intro.html#working-with-data"><span class="std std-ref">Working with Data</span></a> chapters, it might be worth taking a quick spin through them first. You may also find it useful to be familiar with a few of the concepts from the previous Chapter, <a class="reference internal" href="time-intro.html#time-intro"><span class="std std-ref">Introduction to Time</span></a>.</p>
<p>While we’ll cover the basics here, the full set of time series functionality of <strong>pandas</strong> can be <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html">found here</a>.</p>
<p>This chapter has benefitted from the <a class="reference external" href="https://jakevdp.github.io/PythonDataScienceHandbook/">Python Data Science Handbook</a> by Jake VanderPlas, Tom Augspurger’s <a class="reference external" href="https://github.com/TomAugspurger/effective-pandas">Effective Pandas</a>, <a class="reference external" href="https://atsa-es.github.io/">Applied Time Series for Fisheries and Environmental Sciences</a>, and the documentation of the <a class="reference external" href="https://arch.readthedocs.io/"><strong>arch</strong></a> package.</p>
<p>Let’s imports a few of the packages we’ll need first. You may need to install some of these; the Chapter on <a class="reference internal" href="code-preliminaries.html#code-preliminaries"><span class="std std-ref">Preliminaries</span></a> covers how to install new packages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cycle</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.graphics</span><span class="w"> </span><span class="kn">import</span> <span class="n">tsaplots</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;lines.linewidth&quot;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">})</span>
<span class="c1"># Set max rows displayed for readability</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_rows&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="c1"># Set seed for random numbers</span>
<span class="n">seed_for_prng</span> <span class="o">=</span> <span class="mi">78557</span>
<span class="n">prng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span>
    <span class="n">seed_for_prng</span>
<span class="p">)</span>  <span class="c1"># prng=probabilistic random number generator</span>
<span class="c1"># Turn off warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="introducing-time-series-with-pandas">
<h2>Introducing Time Series with <strong>pandas</strong><a class="headerlink" href="#introducing-time-series-with-pandas" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://pandas.pydata.org/"><strong>pandas</strong></a> is the workhorse of time series analysis in Python. The basic object is a <em>timestamp</em>. The <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> function creates timestamps from strings that could reasonably represent datetimes. Let’s see an example of using <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> to create a timestamp and then inspect all of the methods and attributes of the created timestamp using <strong>rich</strong>’s <code class="docutils literal notranslate"><span class="pre">inspect()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;16th of February, 2020&quot;</span><span class="p">)</span>
<span class="n">inspect</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">╭───────── </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">class</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'pandas._libs.tslibs.timestamps.Timestamp'</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">&gt;</span><span style="color: #000080; text-decoration-color: #000080"> ─────────╮</span>
<span style="color: #000080; text-decoration-color: #000080">│</span> <span style="color: #008080; text-decoration-color: #008080">Pandas replacement for python datetime.datetime object.</span>              <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>                                                                      <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span> <span style="color: #008000; text-decoration-color: #008000">╭──────────────────────────────────────────────────────────────────╮</span> <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span> <span style="color: #008000; text-decoration-color: #008000">│</span> <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Timestamp</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'2020-02-16 00:00:00'</span><span style="font-weight: bold">)</span>                                 <span style="color: #008000; text-decoration-color: #008000">│</span> <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span> <span style="color: #008000; text-decoration-color: #008000">╰──────────────────────────────────────────────────────────────────╯</span> <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>                                                                      <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>             <span style="color: #808000; text-decoration-color: #808000; font-style: italic">asm8</span> = <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">numpy.datetime64</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'2020-02-16T00:00:00.000000000'</span><span style="font-weight: bold">)</span> <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>              <span style="color: #808000; text-decoration-color: #808000; font-style: italic">day</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>                                                <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>      <span style="color: #808000; text-decoration-color: #808000; font-style: italic">day_of_week</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>      <span style="color: #808000; text-decoration-color: #808000; font-style: italic">day_of_year</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47</span>                                                <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>        <span style="color: #808000; text-decoration-color: #808000; font-style: italic">dayofweek</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>        <span style="color: #808000; text-decoration-color: #808000; font-style: italic">dayofyear</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47</span>                                                <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>    <span style="color: #808000; text-decoration-color: #808000; font-style: italic">days_in_month</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>                                                <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>      <span style="color: #808000; text-decoration-color: #808000; font-style: italic">daysinmonth</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>                                                <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>             <span style="color: #808000; text-decoration-color: #808000; font-style: italic">fold</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>             <span style="color: #808000; text-decoration-color: #808000; font-style: italic">hour</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>     <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_leap_year</span> = <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                              <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>     <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_month_end</span> = <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                             <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>   <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_month_start</span> = <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                             <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>   <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_quarter_end</span> = <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                             <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span> <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_quarter_start</span> = <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                             <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>      <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_year_end</span> = <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                             <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>    <span style="color: #808000; text-decoration-color: #808000; font-style: italic">is_year_start</span> = <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                             <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>              <span style="color: #808000; text-decoration-color: #808000; font-style: italic">max</span> = <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Timestamp</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'2262-04-11 23:47:16.854775807'</span><span style="font-weight: bold">)</span>        <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>      <span style="color: #808000; text-decoration-color: #808000; font-style: italic">microsecond</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>              <span style="color: #808000; text-decoration-color: #808000; font-style: italic">min</span> = <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Timestamp</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'1677-09-21 00:12:43.145224193'</span><span style="font-weight: bold">)</span>        <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>           <span style="color: #808000; text-decoration-color: #808000; font-style: italic">minute</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>            <span style="color: #808000; text-decoration-color: #808000; font-style: italic">month</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>       <span style="color: #808000; text-decoration-color: #808000; font-style: italic">nanosecond</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>          <span style="color: #808000; text-decoration-color: #808000; font-style: italic">quarter</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>       <span style="color: #808000; text-decoration-color: #808000; font-style: italic">resolution</span> = <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Timedelta</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">'0 days 00:00:00.000000001'</span><span style="font-weight: bold">)</span>            <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>           <span style="color: #808000; text-decoration-color: #808000; font-style: italic">second</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>               <span style="color: #808000; text-decoration-color: #808000; font-style: italic">tz</span> = <span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>                                              <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>           <span style="color: #808000; text-decoration-color: #808000; font-style: italic">tzinfo</span> = <span style="color: #800080; text-decoration-color: #800080; font-style: italic">None</span>                                              <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>             <span style="color: #808000; text-decoration-color: #808000; font-style: italic">unit</span> = <span style="color: #008000; text-decoration-color: #008000">'ns'</span>                                              <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>            <span style="color: #808000; text-decoration-color: #808000; font-style: italic">value</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1581811200000000000</span>                               <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>             <span style="color: #808000; text-decoration-color: #808000; font-style: italic">week</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>       <span style="color: #808000; text-decoration-color: #808000; font-style: italic">weekofyear</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>                                                 <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">│</span>             <span style="color: #808000; text-decoration-color: #808000; font-style: italic">year</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>                                              <span style="color: #000080; text-decoration-color: #000080">│</span>
<span style="color: #000080; text-decoration-color: #000080">╰──────────────────────────────────────────────────────────────────────╯</span>
</pre>
</div></div>
</div>
<p>This is of type <code class="docutils literal notranslate"><span class="pre">Timestamp</span></code> and you can see that it has many of the same properties as the built-in Python <code class="docutils literal notranslate"><span class="pre">datetime.datetime</span></code> class from the previous chapter. As with that, the default setting for <code class="docutils literal notranslate"><span class="pre">tz</span></code> (timezone) and <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>. There are some extra properties, though, such as <code class="docutils literal notranslate"><span class="pre">freq</span></code> for frequency, which will be very useful when it comes to manipulating time <em>series</em> as opposed to just one or two datetimes.</p>
</section>
<section id="creating-and-using-time-series">
<h2>Creating and Using Time Series<a class="headerlink" href="#creating-and-using-time-series" title="Link to this heading">#</a></h2>
<p>There are two main scenarios in which you might be creating time series using <strong>pandas</strong>: i) creating one from scratch or ii) reading in data from a file. Let’s look at a few ways to do i) first.</p>
<p>You can create a time series with <strong>pandas</strong> by taking a date as created above and extending it using <strong>pandas</strong> timedelta function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2020-02-16&#39;, &#39;2020-02-17&#39;, &#39;2020-02-18&#39;, &#39;2020-02-19&#39;,
               &#39;2020-02-20&#39;, &#39;2020-02-21&#39;, &#39;2020-02-22&#39;, &#39;2020-02-23&#39;,
               &#39;2020-02-24&#39;, &#39;2020-02-25&#39;, &#39;2020-02-26&#39;, &#39;2020-02-27&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=None)
</pre></div>
</div>
</div>
</div>
<p>This has created a datetime index of type <code class="docutils literal notranslate"><span class="pre">datetime65[ns]</span></code> (remember, an index is a special type of <strong>pandas</strong> column), where “ns” stands for nano-second resolution.</p>
<p>Another method is to create a range of dates (pass a frequency using the <code class="docutils literal notranslate"><span class="pre">freq=</span></code> keyword argument):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2018/1/1&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;2018/1/8&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2018-01-01&#39;, &#39;2018-01-02&#39;, &#39;2018-01-03&#39;, &#39;2018-01-04&#39;,
               &#39;2018-01-05&#39;, &#39;2018-01-06&#39;, &#39;2018-01-07&#39;, &#39;2018-01-08&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;D&#39;)
</pre></div>
</div>
</div>
</div>
<p>Another way to create ranges is to specify the number of periods and the frequency:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">&quot;2018-01-01&quot;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2018-01-01 00:00:00&#39;, &#39;2018-01-01 01:00:00&#39;,
               &#39;2018-01-01 02:00:00&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;h&#39;)
</pre></div>
</div>
</div>
</div>
<p>Following the discussion of the previous chapter on timezones, you can also localise timezones directly in <strong>pandas</strong> dataframes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dti</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">&quot;2018-01-01&quot;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
<span class="n">dti</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s2">&quot;US/Pacific&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2017-12-31 16:00:00-08:00&#39;, &#39;2017-12-31 17:00:00-08:00&#39;,
               &#39;2017-12-31 18:00:00-08:00&#39;],
              dtype=&#39;datetime64[ns, US/Pacific]&#39;, freq=&#39;h&#39;)
</pre></div>
</div>
</div>
</div>
<p>Now let’s see how to turn data that has been read in with a non-datetime type into a vector of datetimes. This happens <em>all the time</em> in practice. We’ll read in some data on job vacancies for information and communication jobs, ONS code UNEM-JP9P, and then try to wrangle the given “date” column into a <strong>pandas</strong> datetime column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://api.beta.ons.gov.uk/data?uri=/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/timeseries/jp9p/lms&quot;</span>

<span class="c1"># Get the data from the ONS API:</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;months&quot;</span><span class="p">]))</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">]]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Vacancies (ICT), thousands&quot;</span><span class="p">})</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2001 MAY</td>
      <td>50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2001 JUN</td>
      <td>48</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2001 JUL</td>
      <td>47</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2001 AUG</td>
      <td>46</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2001 SEP</td>
      <td>44</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We have the data in. Let’s look at the column types that arrived.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 285 entries, 0 to 284
Data columns (total 2 columns):
 #   Column                      Non-Null Count  Dtype 
---  ------                      --------------  ----- 
 0   date                        285 non-null    object
 1   Vacancies (ICT), thousands  285 non-null    int64 
dtypes: int64(1), object(1)
memory usage: 4.6+ KB
</pre></div>
</div>
</div>
</div>
<p>This is the default ‘object’ type, but we want the date column to have <code class="docutils literal notranslate"><span class="pre">datetime64[ns]</span></code>, which is a datetime type. Again, we use <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0   2001-05-01
1   2001-06-01
2   2001-07-01
3   2001-08-01
4   2001-09-01
Name: date, dtype: datetime64[ns]
</pre></div>
</div>
</div>
</div>
<p>In this case, the conversion from the format of data that was put in of “2001 MAY” to datetime worked out-of-the-box. <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> will always take an educated guess as to the format, but it won’t always work out.</p>
<p>What happens if we have a more tricky-to-read-in datetime column? This frequently occurs in practice so it’s well worth exploring an example. Let’s create some random data with dates in an unusual format with month first, then year, then day, eg “1, ‘19, 29” and so on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">small_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1, &#39;19, 22&quot;</span><span class="p">,</span> <span class="s2">&quot;1, &#39;19, 23&quot;</span><span class="p">],</span> <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]})</span>
<span class="n">small_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    1, &#39;19, 22
1    1, &#39;19, 23
Name: date, dtype: object
</pre></div>
</div>
</div>
</div>
<p>Now, if we were to run this via <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> with no further input, it would misinterpret, for example, the first date as <code class="docutils literal notranslate"><span class="pre">2022-01-19</span></code>. So we must pass a bit more info to <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> to help it out. We can pass a <code class="docutils literal notranslate"><span class="pre">format=</span></code> keyword argument with the format that the datetime takes. Here, we’ll use <code class="docutils literal notranslate"><span class="pre">%m</span></code> for month in number format, <code class="docutils literal notranslate"><span class="pre">%y</span></code> for year in 2-digit format, and <code class="docutils literal notranslate"><span class="pre">%d</span></code> for 2-digit day. We can also add in the other characters such as <code class="docutils literal notranslate"><span class="pre">'</span></code> and <code class="docutils literal notranslate"><span class="pre">,</span></code>. You can find a list of datetime format identifiers in the previous chapter or over at <a class="reference external" href="https://strftime.org/">https://strftime.org/</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">small_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%m, &#39;%y, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0   2019-01-22
1   2019-01-23
Name: date, dtype: datetime64[ns]
</pre></div>
</div>
</div>
</div>
<section id="datetime-offsets">
<h3>Datetime Offsets<a class="headerlink" href="#datetime-offsets" title="Link to this heading">#</a></h3>
<p>Our data, currently held in <code class="docutils literal notranslate"><span class="pre">df</span></code>, were read in as if they were from the <em>start</em> of the month but these data refer to the month that has passed and so should be for the <em>end</em> of the month. Fortunately, we can change this using a time offset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2001-05-31</td>
      <td>50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2001-06-30</td>
      <td>48</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2001-07-31</td>
      <td>47</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2001-08-31</td>
      <td>46</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2001-09-30</td>
      <td>44</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>While we used the <code class="docutils literal notranslate"><span class="pre">MonthEnd</span></code> offset here, there are many different offsets available. You can find a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects">full table of date offsets here</a>.</p>
</section>
<section id="the-dt-accessor">
<h3>The <code class="docutils literal notranslate"><span class="pre">.dt</span></code> accessor<a class="headerlink" href="#the-dt-accessor" title="Link to this heading">#</a></h3>
<p>When you have a datetime column, you can use the <code class="docutils literal notranslate"><span class="pre">.dt</span></code> accessor to grab lots of useful information from it such as the <code class="docutils literal notranslate"><span class="pre">minute</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, and so on. Some that are functions, rather than just accessors of underlying properties, are followed by brackets, <code class="docutils literal notranslate"><span class="pre">()</span></code>, because they are functions. Here are a few useful examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rich</span><span class="w"> </span><span class="kn">import</span> <span class="nb">print</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using `dt.day_name()`&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using `dt.isocalendar()`&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using `dt.month`&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Using `<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">dt.day_name</span><span style="font-weight: bold">()</span>`
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>    Thursday
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>    Saturday
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>     Tuesday
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>      Friday
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>      Sunday
Name: date, dtype: object
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Using `<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">dt.isocalendar</span><span style="font-weight: bold">()</span>`
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">   year  week  day
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2001</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2001</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2001</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2001</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2001</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Using `dt.month`
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>
Name: date, dtype: int32
</pre>
</div></div>
</div>
</section>
<section id="creating-a-datetime-index-and-setting-the-frequency">
<h3>Creating a datetime index and setting the frequency<a class="headerlink" href="#creating-a-datetime-index-and-setting-the-frequency" title="Link to this heading">#</a></h3>
<p>For the subsequent parts, we’ll set the datetime column to be the index of the dataframe. <em>This is the standard setup you will likely want to use when dealing with time series.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-05-31</th>
      <td>50</td>
    </tr>
    <tr>
      <th>2001-06-30</th>
      <td>48</td>
    </tr>
    <tr>
      <th>2001-07-31</th>
      <td>47</td>
    </tr>
    <tr>
      <th>2001-08-31</th>
      <td>46</td>
    </tr>
    <tr>
      <th>2001-09-30</th>
      <td>44</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now, if we look at the first few entries of the index of dataframe (a datetime index) using <code class="docutils literal notranslate"><span class="pre">head()</span></code> as above, we’ll see that the <code class="docutils literal notranslate"><span class="pre">freq=</span></code> parameter is set as <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2001-05-31&#39;, &#39;2001-06-30&#39;, &#39;2001-07-31&#39;, &#39;2001-08-31&#39;,
               &#39;2001-09-30&#39;],
              dtype=&#39;datetime64[ns]&#39;, name=&#39;date&#39;, freq=None)
</pre></div>
</div>
</div>
</div>
<p>This can be set for the whole dataframe using the <code class="docutils literal notranslate"><span class="pre">asfreq</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2001-05-31&#39;, &#39;2001-06-30&#39;, &#39;2001-07-31&#39;, &#39;2001-08-31&#39;,
               &#39;2001-09-30&#39;],
              dtype=&#39;datetime64[ns]&#39;, name=&#39;date&#39;, freq=&#39;ME&#39;)
</pre></div>
</div>
</div>
</div>
<p>Although most of the time it doesn’t matter about the fact that <code class="docutils literal notranslate"><span class="pre">freq=None</span></code>, some aggregation operations need to know the frequency of the time series in order to work and it’s good practice to set it if your data <em>are</em> regular. You can use <code class="docutils literal notranslate"><span class="pre">asfreq</span></code> to go from a higher frequency to a lower frequency too: the last entry from the higher frequency that aligns with the lower frequency will be taken, for example in going from months to years, December’s value would be used.</p>
<p>Note that trying to set the frequency when your datetime index doesn’t match up to a particular frequency will cause errors or problems.</p>
<p>A few useful frequencies to know about are in the table below; all of these can be used with <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> too.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Represents</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>D</p></td>
<td><p>Calendar day</p></td>
</tr>
<tr class="row-odd"><td><p>W</p></td>
<td><p>Weekly</p></td>
</tr>
<tr class="row-even"><td><p>M</p></td>
<td><p>Month end</p></td>
</tr>
<tr class="row-odd"><td><p>Q</p></td>
<td><p>Quarter end</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>Year end</p></td>
</tr>
<tr class="row-odd"><td><p>H</p></td>
<td><p>Hours</p></td>
</tr>
<tr class="row-even"><td><p>T</p></td>
<td><p>Minutes</p></td>
</tr>
<tr class="row-odd"><td><p>S</p></td>
<td><p>Seconds</p></td>
</tr>
<tr class="row-even"><td><p>B</p></td>
<td><p>Business day</p></td>
</tr>
<tr class="row-odd"><td><p>BM</p></td>
<td><p>Business month end</p></td>
</tr>
<tr class="row-even"><td><p>BQ</p></td>
<td><p>Business quarter end</p></td>
</tr>
<tr class="row-odd"><td><p>BA</p></td>
<td><p>Business year end</p></td>
</tr>
<tr class="row-even"><td><p>BH</p></td>
<td><p>Business hours</p></td>
</tr>
<tr class="row-odd"><td><p>MS</p></td>
<td><p>Month start</p></td>
</tr>
<tr class="row-even"><td><p>QS</p></td>
<td><p>Quarter start</p></td>
</tr>
<tr class="row-odd"><td><p>W-SUN</p></td>
<td><p>Weeks beginning with Sunday (similar for other days)</p></td>
</tr>
<tr class="row-even"><td><p>2M</p></td>
<td><p>Every 2 months (works with other combinations of numbers and codes)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="making-quick-time-series-plots">
<h2>Making Quick Time Series Plots<a class="headerlink" href="#making-quick-time-series-plots" title="Link to this heading">#</a></h2>
<p>Having managed to put your time series into a dataframe, perhaps converting a column of type string into a column of type datetime in the process, you often just want to see the thing! We can achieve this using the <code class="docutils literal notranslate"><span class="pre">plot()</span></code> command, as long as we have a datetime index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/abf715d7e349c268d0e984f5f79dee4690d1dce0089981813f82f43655d85bf9.svg" src="_images/abf715d7e349c268d0e984f5f79dee4690d1dce0089981813f82f43655d85bf9.svg" />
</div>
</div>
</section>
<section id="resampling-rolling-and-shifting">
<h2>Resampling, Rolling, and Shifting<a class="headerlink" href="#resampling-rolling-and-shifting" title="Link to this heading">#</a></h2>
<p>Now our data have a <em>datetime index</em>, some common time series operations are made very easy for us.</p>
<section id="resampling">
<h3>Resampling<a class="headerlink" href="#resampling" title="Link to this heading">#</a></h3>
<p>Quite frequently, there is a situation in which one would like to change the frequency of a given time series. A time index-based dataframe makes this easy via the <code class="docutils literal notranslate"><span class="pre">resample()</span></code> function. <code class="docutils literal notranslate"><span class="pre">resample()</span></code> must be told <em>how</em> you’d like to resample the data, for example via the mean or median. Here’s an example resampling the monthly data to annual and taking the mean:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-12-31</th>
      <td>44.875000</td>
    </tr>
    <tr>
      <th>2002-12-31</th>
      <td>42.666667</td>
    </tr>
    <tr>
      <th>2003-12-31</th>
      <td>39.833333</td>
    </tr>
    <tr>
      <th>2004-12-31</th>
      <td>44.750000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-12-31</th>
      <td>68.416667</td>
    </tr>
    <tr>
      <th>2023-12-31</th>
      <td>47.166667</td>
    </tr>
    <tr>
      <th>2024-12-31</th>
      <td>39.083333</td>
    </tr>
    <tr>
      <th>2025-12-31</th>
      <td>36.000000</td>
    </tr>
  </tbody>
</table>
<p>25 rows × 1 columns</p>
</div></div></div>
</div>
<p>As resample is just a special type of aggregation, it can work with all of the usual functions that aggregations do, including in-built functions or user-defined functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;5A&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-12-31</th>
      <td>44.875000</td>
      <td>3.482097</td>
    </tr>
    <tr>
      <th>2006-12-31</th>
      <td>41.583333</td>
      <td>2.465296</td>
    </tr>
    <tr>
      <th>2011-12-31</th>
      <td>32.300000</td>
      <td>6.763060</td>
    </tr>
    <tr>
      <th>2016-12-31</th>
      <td>34.433333</td>
      <td>5.002937</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>43.433333</td>
      <td>11.983557</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Resampling can go up in frequency (up-sampling) as well as down, but we no longer need to choose an aggregation function, we must now choose how we’d like to fill in the gaps for the frequencies we didn’t have in the original data. In the example below, they are just left as NaNs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-05-31</th>
      <td>50.0</td>
    </tr>
    <tr>
      <th>2001-06-01</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-06-02</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-06-03</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2025-01-28</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2025-01-29</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2025-01-30</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2025-01-31</th>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>8647 rows × 1 columns</p>
</div></div></div>
</div>
<p>Options to fill in missing time series data include using <code class="docutils literal notranslate"><span class="pre">bfill()</span></code> or <code class="docutils literal notranslate"><span class="pre">ffill()</span></code> to fill in the blanks based on the next or last available value, respectively, or <code class="docutils literal notranslate"><span class="pre">interpolate()</span></code> (note how only the first 3 NaNs are replaced using the <code class="docutils literal notranslate"><span class="pre">limit</span></code> keyword argument):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">limit_direction</span><span class="o">=</span><span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-05-31</th>
      <td>50.000000</td>
    </tr>
    <tr>
      <th>2001-06-01</th>
      <td>49.933333</td>
    </tr>
    <tr>
      <th>2001-06-02</th>
      <td>49.866667</td>
    </tr>
    <tr>
      <th>2001-06-03</th>
      <td>49.800000</td>
    </tr>
    <tr>
      <th>2001-06-04</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-06-05</th>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can see the differences between the filling methods more clearly in this stock market data, following a chart by Jake Vanderplas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get stock market data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_datareader</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">web</span>

<span class="n">xf</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span> <span class="s2">&quot;stooq&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">&quot;2017-01-01&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;2019-06-01&quot;</span><span class="p">)</span>
<span class="n">xf</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>


<span class="n">colour_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
<span class="n">iter_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">colour_list</span><span class="p">)</span>


<span class="n">data</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">iter_cycle</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bfill&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;-.o&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">iter_cycle</span><span class="p">))</span>
<span class="n">data</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;--o&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">iter_cycle</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Close ($)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;original&quot;</span><span class="p">,</span> <span class="s2">&quot;back-fill&quot;</span><span class="p">,</span> <span class="s2">&quot;forward-fill&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/70356cf4a67243466e2c695a560d62ea89fd4865ab2b6a3cf9182f64b0884c37.svg" src="_images/70356cf4a67243466e2c695a560d62ea89fd4865ab2b6a3cf9182f64b0884c37.svg" />
</div>
</div>
</section>
<section id="rolling-window-functions">
<h3>Rolling Window Functions<a class="headerlink" href="#rolling-window-functions" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">rolling()</span></code> and <code class="docutils literal notranslate"><span class="pre">ewm()</span></code> methods are both rolling window functions. The first includes functions of the sequence</p>
<div class="math notranslate nohighlight">
\[
y_t = f(\{x_{t-i} \}_{i=0}^{i=R-1})
\]</div>
<p>where <span class="math notranslate nohighlight">\(R\)</span> is the number of periods to use for the rolling window. For example, if the function is the mean, then <span class="math notranslate nohighlight">\(f\)</span> takes the form <span class="math notranslate nohighlight">\(\frac{1}{R}\displaystyle\sum_{i=0}^{i=R-1} x_{t-i}\)</span>.</p>
<p>The example below is a 2-period rolling mean:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-05-31</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-06-30</th>
      <td>49.0</td>
    </tr>
    <tr>
      <th>2001-07-31</th>
      <td>47.5</td>
    </tr>
    <tr>
      <th>2001-08-31</th>
      <td>46.5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-10-31</th>
      <td>38.0</td>
    </tr>
    <tr>
      <th>2024-11-30</th>
      <td>38.0</td>
    </tr>
    <tr>
      <th>2024-12-31</th>
      <td>37.5</td>
    </tr>
    <tr>
      <th>2025-01-31</th>
      <td>36.5</td>
    </tr>
  </tbody>
</table>
<p>285 rows × 1 columns</p>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ewm()</span></code> includes the class of functions where data point <span class="math notranslate nohighlight">\(x_{t-i}\)</span> has a weight <span class="math notranslate nohighlight">\(w_i = (1-\alpha)^i\)</span>. As <span class="math notranslate nohighlight">\(0 &lt; \alpha &lt; 1\)</span>, points further back in time are given less weight. For example, an exponentially moving average is given by</p>
<div class="math notranslate nohighlight">
\[
y_t = \frac{x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...
+ (1 - \alpha)^t x_{0}}{1 + (1 - \alpha) + (1 - \alpha)^2 + ...
+ (1 - \alpha)^t}
\]</div>
<p>The example below shows the code for the exponentially weighted moving average:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-05-31</th>
      <td>50.000000</td>
    </tr>
    <tr>
      <th>2001-06-30</th>
      <td>48.888889</td>
    </tr>
    <tr>
      <th>2001-07-31</th>
      <td>48.114754</td>
    </tr>
    <tr>
      <th>2001-08-31</th>
      <td>47.398374</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-10-31</th>
      <td>39.309938</td>
    </tr>
    <tr>
      <th>2024-11-30</th>
      <td>39.047950</td>
    </tr>
    <tr>
      <th>2024-12-31</th>
      <td>38.638360</td>
    </tr>
    <tr>
      <th>2025-01-31</th>
      <td>38.110688</td>
    </tr>
  </tbody>
</table>
<p>285 rows × 1 columns</p>
</div></div></div>
</div>
<p>Let’s see these methods together on the stock market data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">roll_num</span> <span class="o">=</span> <span class="mi">28</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">xf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raw&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">xf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expanding Average&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">xf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;EWMA ($</span><span class="se">\\</span><span class="s2">alpha=$</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
<span class="p">)</span>
<span class="n">xf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">roll_num</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">roll_num</span><span class="si">}</span><span class="s2">D MA&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Close ($)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/76463938e71f291a0d5e8f2384a918dc67f2ff4634a42c413e890db527b8bb11.svg" src="_images/76463938e71f291a0d5e8f2384a918dc67f2ff4634a42c413e890db527b8bb11.svg" />
</div>
</div>
<p>For more tools to analyse stocks, see the <a class="reference external" href="https://twopirllc.github.io/pandas-ta/"><strong>Pandas TA</strong></a> package.</p>
<p>We can also use <code class="docutils literal notranslate"><span class="pre">rolling()</span></code> as an intermediate step in creating more than one type of aggregation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">roll</span> <span class="o">=</span> <span class="n">xf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">roll</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">])</span>
<span class="n">m</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Close ($)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/50f4f7dd5c3bd1e08135d16d834850db352ab808b63f5568c2b8d534a469faec.svg" src="_images/50f4f7dd5c3bd1e08135d16d834850db352ab808b63f5568c2b8d534a469faec.svg" />
</div>
</div>
</section>
<section id="shifting">
<h3>Shifting<a class="headerlink" href="#shifting" title="Link to this heading">#</a></h3>
<p>Shifting can move series around in time; it’s what we need to create leads and lags of time series. Let’s create a lead and a lag in the data. Remember that a lead is going to shift the pattern in the data to the left (ie earlier in time), while the lag is going to shift patterns later in time (ie to the right).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lead</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">lag</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">orig_series_name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;lead (</span><span class="si">{</span><span class="n">lead</span><span class="si">}</span><span class="s2"> months)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">orig_series_name</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">lead</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;lag (</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2"> months)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">orig_series_name</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Vacancies (ICT), thousands</th>
      <th>lead (12 months)</th>
      <th>lag (3 months)</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2001-05-31</th>
      <td>50</td>
      <td>44.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-06-30</th>
      <td>48</td>
      <td>45.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-07-31</th>
      <td>47</td>
      <td>45.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2001-08-31</th>
      <td>46</td>
      <td>43.0</td>
      <td>50.0</td>
    </tr>
    <tr>
      <th>2001-09-30</th>
      <td>44</td>
      <td>40.0</td>
      <td>48.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bdc0e5e7b8a879226536f8bfdab811234434e962f38a466b3425a1c2cbb107dd.svg" src="_images/bdc0e5e7b8a879226536f8bfdab811234434e962f38a466b3425a1c2cbb107dd.svg" />
</div>
</div>
</section>
</section>
<section id="correlations">
<h2>Correlations<a class="headerlink" href="#correlations" title="Link to this heading">#</a></h2>
<p>In this section, we’ll look at some different ways of comparing time series using simple metrics.</p>
<section id="autocorrelation">
<h3>Autocorrelation<a class="headerlink" href="#autocorrelation" title="Link to this heading">#</a></h3>
<p>First, what about comparing a time series to itself? The autocorrelation of a time series tells you how persistent it is. The econometrics package <a class="reference internal" href="#"><span class="xref myst"><strong>statsmodels</strong></span></a> has some tools for this, most notably <code class="docutils literal notranslate"><span class="pre">statsmodels.tsa.stattools.acf</span></code>. Sometimes what you want is just a visual cue though, in which case the code below produces a nice chart.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">tsaplots</span><span class="o">.</span><span class="n">plot_acf</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Vacancies (ICT), thousands&quot;</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/697f6c47b6631c0e696fa219db6d9c1ed1e3cb16179fee6ae00beeef291d4511.svg" src="_images/697f6c47b6631c0e696fa219db6d9c1ed1e3cb16179fee6ae00beeef291d4511.svg" />
</div>
</div>
<p>Rememebr that the autocorrelation can tell you about likely terms to include in a moving average (MA) model.</p>
<p>We can also look at the <em>partial autocorrelation</em>, which, at a given lag, is the correlation that results after removing the effect of any correlations due to the terms at shorter lags. It can be computer via the <code class="docutils literal notranslate"><span class="pre">statsmodels.tsa.stattools.pacf</span></code> function, but here’s a chart:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">tsaplots</span><span class="o">.</span><span class="n">plot_pacf</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Vacancies (ICT), thousands&quot;</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/816c864e05aecb2d9624b6366f309917f8735247200ce65b5c422fae091fb2ee.svg" src="_images/816c864e05aecb2d9624b6366f309917f8735247200ce65b5c422fae091fb2ee.svg" />
</div>
</div>
<p>Remember that the partial autocorrelation function can tell you about likely terms to include in an autoregressive (AR) model.</p>
<p>By looking at both the ACF and PACF, you can get an idea of what terms would be good to include in <em>both</em> an MA and AR model which, combined, make an ARMA model. It’s also worth noting that, if the ACF and PACF do not seem to tail off, the series is likely to be non-stationary and differencing will be needed if you are going to model it with an ARMA approach.</p>
</section>
<section id="correlations-with-other-series">
<h3>Correlations with Other Series<a class="headerlink" href="#correlations-with-other-series" title="Link to this heading">#</a></h3>
<p>To compute correlations with other time series, a popular choice is the cross-correlation function (CCF). Confusingly, there are different definitions of this object in statistics and signal processing. In statistics, it’s given by</p>
<div class="math notranslate nohighlight">
\[
r_k = \frac{g_k}{\sqrt{\sigma_x\sigma_y}};
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
g_k = \frac{1}{n}\sum_{t=1}^{n-k} \left(y_t-\bar{y}\right) \left(x_{t+k}-\bar{x}\right),
\]</div>
<p>and <span class="math notranslate nohighlight">\(k\)</span> is set by a rule of thumb, usually something like <span class="math notranslate nohighlight">\(10 \log_{10}\left(\min(|x|, |y|)/2\right)\)</span>. <span class="math notranslate nohighlight">\(g_k\)</span> is the ‘sliding’ dot product of <span class="math notranslate nohighlight">\(y\)</span>, the response, with <span class="math notranslate nohighlight">\(x\)</span>, the predictor, up to the <span class="math notranslate nohighlight">\(k\)</span> th lag.</p>
<p>The default cross-correlation function in <strong>statsmodels</strong> is different. It only looks forward, and it computes <em>all</em> possible lags. You can call it via <code class="docutils literal notranslate"><span class="pre">sm.ccf</span></code> if you have already run <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">statsmodels.api</span> <span class="pre">as</span> <span class="pre">sm</span></code>.</p>
<p>We’ll use the standard stats treatment here, but we’ll need to define a function to do the computation we need. Then we’ll apply the CCF to a classic example: the response of the number of Lynx trapped (in Canada) to sunspot activity.</p>
<p>First, defining the function. We’ll make use of the signal processing <code class="docutils literal notranslate"><span class="pre">ss.correlate()</span></code> function but modify it so that adopts the definition of CCF used in statistics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ss</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ccf_stats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lag_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lag_max</span><span class="p">:</span>
        <span class="n">lag_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">lag_max</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="p">(</span><span class="n">lag_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">lo</span><span class="p">:</span><span class="n">hi</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s grab the two different datasets and merge them, taking a quick look while we’re at it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lynx_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://vincentarelbundock.github.io/Rdatasets/csv/datasets/lynx.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
<span class="n">spot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://vincentarelbundock.github.io/Rdatasets/csv/datasets/sunspot.year.csv&quot;</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">lynx_df</span><span class="p">,</span> <span class="n">spot_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_lynx&quot;</span><span class="p">,</span> <span class="s2">&quot;_sunspots&quot;</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>value_lynx</th>
      <th>value_sunspots</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1821</th>
      <td>269</td>
      <td>6.6</td>
    </tr>
    <tr>
      <th>1822</th>
      <td>321</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>1823</th>
      <td>585</td>
      <td>1.8</td>
    </tr>
    <tr>
      <th>1824</th>
      <td>871</td>
      <td>8.5</td>
    </tr>
    <tr>
      <th>1825</th>
      <td>1475</td>
      <td>16.6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/31909904582e7f0fda4dca5a86af57cf4d9498769ac59bc22e32cfc4751e9917.svg" src="_images/31909904582e7f0fda4dca5a86af57cf4d9498769ac59bc22e32cfc4751e9917.svg" />
</div>
</div>
<p>Let’s use our defined function on the data. We’ll add in a rough confidence interval of <span class="math notranslate nohighlight">\(\pm \frac{2}{\sqrt{n}}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ccf_res_stats</span> <span class="o">=</span> <span class="n">ccf_stats</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value_sunspots&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value_lynx&quot;</span><span class="p">]))</span>
<span class="n">conf_int</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccf_res_stats</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccf_res_stats</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">ccf_res_stats</span><span class="p">,</span>
    <span class="n">basefmt</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="n">markerfmt</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="n">conf_int</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">conf_int</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cross-correlation&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Lag&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1ea9df7fdc8e6802b0afbd824123c4e0ee38bf9c6b16fe2bf970efdb6d910132.svg" src="_images/1ea9df7fdc8e6802b0afbd824123c4e0ee38bf9c6b16fe2bf970efdb6d910132.svg" />
</div>
</div>
<p>The significant correlations at lags of -3 to -5 seem to suggest that lynx numbers fall in the 3 to 5 years after high sunspot activity.</p>
</section>
</section>
<section id="transformations">
<h2>Transformations<a class="headerlink" href="#transformations" title="Link to this heading">#</a></h2>
<p>There are many reasons why you might want to perform transformations on series, including to normalise data and to adjust for changes (such as inflation). In this section, we’ll look at some of the most common transforms for time series.</p>
<section id="mathematical-transformations">
<h3>Mathematical Transformations<a class="headerlink" href="#mathematical-transformations" title="Link to this heading">#</a></h3>
<p>The usual transformations that we know and love from other series of numerical data can equally be applied to time series, for example the log and power transforms. Let’s see some of these in action using data on US GDP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_datareader.data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">web</span>

<span class="n">ts_start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2009-01-01&quot;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;NA000334Q&quot;</span><span class="p">,</span> <span class="s2">&quot;fred&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">ts_start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gdp</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01</th>
      <td>3522117</td>
    </tr>
    <tr>
      <th>2009-04-01</th>
      <td>3598010</td>
    </tr>
    <tr>
      <th>2009-07-01</th>
      <td>3623204</td>
    </tr>
    <tr>
      <th>2009-10-01</th>
      <td>3734738</td>
    </tr>
    <tr>
      <th>2010-01-01</th>
      <td>3602418</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now let’s create new columns for each of log, square, and square root transforms. All of these mathematical transformations can be found in <strong>numpy</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;square&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;sqrt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gdp</th>
      <th>log</th>
      <th>square</th>
      <th>sqrt</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01</th>
      <td>3522117</td>
      <td>15.074573</td>
      <td>12405308161689</td>
      <td>1876.730402</td>
    </tr>
    <tr>
      <th>2009-04-01</th>
      <td>3598010</td>
      <td>15.095891</td>
      <td>12945675960100</td>
      <td>1896.842113</td>
    </tr>
    <tr>
      <th>2009-07-01</th>
      <td>3623204</td>
      <td>15.102869</td>
      <td>13127607225616</td>
      <td>1903.471565</td>
    </tr>
    <tr>
      <th>2009-10-01</th>
      <td>3734738</td>
      <td>15.133188</td>
      <td>13948267928644</td>
      <td>1932.547024</td>
    </tr>
    <tr>
      <th>2010-01-01</th>
      <td>3602418</td>
      <td>15.097116</td>
      <td>12977415446724</td>
      <td>1898.003688</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A very common transformation is to change to growth space. In time series maths, this is <span class="math notranslate nohighlight">\(\frac{y_t}{y_{t-1}}\)</span> for period-on-period growth or, say, <span class="math notranslate nohighlight">\(\frac{y_t}{y_{t-4}}\)</span> for growth relative to 4 periods ago.</p>
<p>Let’s add in quarter-on-quarter-a-year-ago and quarter-on-quarter growth rates to our growing list of transforms:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;q_on_q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;q_on_q_yr_ago&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gdp</th>
      <th>log</th>
      <th>square</th>
      <th>sqrt</th>
      <th>q_on_q</th>
      <th>q_on_q_yr_ago</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-10-01</th>
      <td>7159264</td>
      <td>15.783918</td>
      <td>51255061021696</td>
      <td>2675.680100</td>
      <td>1.851570</td>
      <td>5.363882</td>
    </tr>
    <tr>
      <th>2024-01-01</th>
      <td>6997823</td>
      <td>15.761110</td>
      <td>48969526739329</td>
      <td>2645.339865</td>
      <td>-2.254994</td>
      <td>5.391488</td>
    </tr>
    <tr>
      <th>2024-04-01</th>
      <td>7290539</td>
      <td>15.802088</td>
      <td>53151958910521</td>
      <td>2700.099813</td>
      <td>4.182958</td>
      <td>5.694604</td>
    </tr>
    <tr>
      <th>2024-07-01</th>
      <td>7364675</td>
      <td>15.812205</td>
      <td>54238437855625</td>
      <td>2713.793470</td>
      <td>1.016880</td>
      <td>4.773858</td>
    </tr>
    <tr>
      <th>2024-10-01</th>
      <td>7557065</td>
      <td>15.837993</td>
      <td>57109231414225</td>
      <td>2749.011641</td>
      <td>2.612335</td>
      <td>5.556451</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Another classic transform you might need is to de-mean your data. We are transforming such that</p>
<div class="math notranslate nohighlight">
\[
y_t' = y_t - \langle y_t \rangle
\]</div>
<p>where the angular brackets denote a mean. Here’s an example of that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;demean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;gdp&quot;</span><span class="p">,</span> <span class="s2">&quot;demean&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gdp</th>
      <th>demean</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-10-01</th>
      <td>7159264</td>
      <td>2.116008e+06</td>
    </tr>
    <tr>
      <th>2024-01-01</th>
      <td>6997823</td>
      <td>1.954567e+06</td>
    </tr>
    <tr>
      <th>2024-04-01</th>
      <td>7290539</td>
      <td>2.247283e+06</td>
    </tr>
    <tr>
      <th>2024-07-01</th>
      <td>7364675</td>
      <td>2.321419e+06</td>
    </tr>
    <tr>
      <th>2024-10-01</th>
      <td>7557065</td>
      <td>2.513809e+06</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Be wary though! The mean is a function that, by default, uses all time periods, so you need to be careful if you’re working on a real-time data problem such as forecasting. In this case you only want to use the mean <em>up to that point in time</em> to demean a series. Mathematically, this is</p>
<div class="math notranslate nohighlight">
\[
y_t' = y_t - \frac{1}{t+1}\displaystyle{\sum_{\tau=0}^{\tau=t} y_\tau}
\]</div>
<p>To do this, we can make use of the <strong>pandas</strong> <em>expanding</em> functionality we saw earlier. Here’s an example of real-time demeaning:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;real_time_demean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;gdp&quot;</span><span class="p">,</span> <span class="s2">&quot;real_time_demean&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gdp</th>
      <th>real_time_demean</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01</th>
      <td>3522117</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2009-04-01</th>
      <td>3598010</td>
      <td>37946.500000</td>
    </tr>
    <tr>
      <th>2009-07-01</th>
      <td>3623204</td>
      <td>42093.666667</td>
    </tr>
    <tr>
      <th>2009-10-01</th>
      <td>3734738</td>
      <td>115220.750000</td>
    </tr>
    <tr>
      <th>2010-01-01</th>
      <td>3602418</td>
      <td>-13679.400000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note how the second real-time demeaned entry is the second entry for GDP minus the average of the second and first entries of GDP. A more general way of avoiding data leakage is to use <strong>scikit-learn</strong>’s <a class="reference external" href="https://scikit-learn.org/stable/modules/compose.html#pipeline">pipeline</a> functionality.</p>
<p>Let’s move on to another classic transformation: differences. These are given by</p>
<div class="math notranslate nohighlight">
\[
\Delta y_t = y_t - y_{t-1}
\]</div>
<p>Note that, in this case, the first entry in the differences won’t be defined (ie appears as <code class="docutils literal notranslate"><span class="pre">NaN</span></code>) because there is no <span class="math notranslate nohighlight">\(\text{gdp}_{t=-1}\)</span>. Use <code class="docutils literal notranslate"><span class="pre">diff(n)</span></code> to get <span class="math notranslate nohighlight">\(y_t - y_{t-n}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gdp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;gdp&quot;</span><span class="p">,</span> <span class="s2">&quot;difference&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gdp</th>
      <th>difference</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01</th>
      <td>3522117</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2009-04-01</th>
      <td>3598010</td>
      <td>75893.0</td>
    </tr>
    <tr>
      <th>2009-07-01</th>
      <td>3623204</td>
      <td>25194.0</td>
    </tr>
    <tr>
      <th>2009-10-01</th>
      <td>3734738</td>
      <td>111534.0</td>
    </tr>
    <tr>
      <th>2010-01-01</th>
      <td>3602418</td>
      <td>-132320.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="the-box-cox-transform">
<h4>The Box-Cox Transform<a class="headerlink" href="#the-box-cox-transform" title="Link to this heading">#</a></h4>
<p>This transform actually nests power transforms and logarithms, depending on the value of a parameter that is usually denoted <span class="math notranslate nohighlight">\(\lambda\)</span>. The transform is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
y_t'  =
    \begin{cases}
      \ln(y_t) &amp; \text{if $\lambda=0$};  \\
      (y_t^\lambda-1)/\lambda &amp; \text{otherwise}.
    \end{cases}
\end{split}\]</div>
<p>How do you choose <span class="math notranslate nohighlight">\(\lambda\)</span>? One way is to choose such that the transformed data resemble a normal distribution. Let’s see a couple of examples, including an optimal value for <span class="math notranslate nohighlight">\(\lambda\)</span> as determined by <strong>scipy</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">prng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1"># Last entry of the list gets the optimal value for lambda</span>
<span class="n">λ_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>
<span class="c1"># One extra plot for the original data</span>
<span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">λ_values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="c1"># For fitting a normal distribution</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="mi">30</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">num_plots</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">num_plots</span> <span class="o">-</span> <span class="n">num_plots</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">boxcox</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="n">λ_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\lambda =$&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">λ_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">λ_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\lambda^*=$&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">λ_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Box Cox Transformed Distributions&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c0c7cd1f8d719cfdde830b1d7a6bd68288de327f658b76a9ec8f82888d790f8e.svg" src="_images/c0c7cd1f8d719cfdde830b1d7a6bd68288de327f658b76a9ec8f82888d790f8e.svg" />
</div>
</div>
<p>You can reverse the Box Cox transform using <strong>scipy</strong>’s <code class="docutils literal notranslate"><span class="pre">scipy.special.inv_boxcox(y,</span> <span class="pre">lmbda)</span></code> function. This is useful if you have performed an operation on the transformed data, for example a forecast, and want to transform the outputs back into the original space.</p>
</section>
</section>
<section id="adjusting-for-inflation">
<h3>Adjusting for Inflation<a class="headerlink" href="#adjusting-for-inflation" title="Link to this heading">#</a></h3>
<p>This one’s mighty important! As every economist knows, the value of money changes over time: a dollar in 1963 does not buy the same bundle of goods and services as a dollar in 2021 would. The price level has changed considerably between those two times. Let’s say we have prices in year <span class="math notranslate nohighlight">\(t\)</span> given by <span class="math notranslate nohighlight">\(y_t\)</span>. Then the price of that same good or service in year <span class="math notranslate nohighlight">\(\omega\)</span> is</p>
<div class="math notranslate nohighlight">
\[
y_\omega = y_t \frac{\pi_{\omega}} {\pi_t}
\]</div>
<p>for example, to find the price of a television in 2021 dollars using data on televisions from 2000 we would do <span class="math notranslate nohighlight">\(y_{2021} = y_{2000} \cdot \frac{\pi_{2021}}{\pi_{2000}}\)</span>. Note that <span class="math notranslate nohighlight">\(\pi\)</span> here is being used as a symbol for inflation, <em>not</em> the ratio of a circle’s circumference to its diameter in Euclidean space!</p>
<p>Let’s see a real example using data on an important good, cheese. We’ll grab the average price per pound of cheese in US cities and adjust it to be in 2012 dollars using the PCE (personal consumption expenditure) price index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fred_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;PCEPI&quot;</span><span class="p">:</span> <span class="s2">&quot;inflation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;APU0000710212&quot;</span><span class="p">:</span> <span class="s2">&quot;cheddar&quot;</span><span class="p">,</span>  <span class="c1"># Avg price per pound in US cities</span>
<span class="p">}</span>


<span class="n">cdf</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="s2">&quot;fred&quot;</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2000-01-01&quot;</span><span class="p">),</span>
                <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fred_codes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">fred_codes</span><span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">cdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>inflation</th>
      <th>cheddar</th>
    </tr>
    <tr>
      <th>DATE</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-12-31</th>
      <td>73.822167</td>
      <td>3.829917</td>
    </tr>
    <tr>
      <th>2001-12-31</th>
      <td>75.302083</td>
      <td>4.026917</td>
    </tr>
    <tr>
      <th>2002-12-31</th>
      <td>76.291083</td>
      <td>4.218083</td>
    </tr>
    <tr>
      <th>2003-12-31</th>
      <td>77.893750</td>
      <td>3.948417</td>
    </tr>
    <tr>
      <th>2004-12-31</th>
      <td>79.827333</td>
      <td>4.272917</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf</span><span class="p">[</span><span class="s2">&quot;cheddar_i_adjust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">cdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;2021-12-31&quot;</span><span class="p">,</span> <span class="s2">&quot;inflation&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cdf</span><span class="p">[</span><span class="s2">&quot;cheddar&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cdf</span><span class="p">[</span><span class="s2">&quot;inflation&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cdf</span><span class="p">[</span><span class="s2">&quot;cheddar&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cheddar (nominal USD)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cdf</span><span class="p">[</span><span class="s2">&quot;cheddar_i_adjust&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cheddar (2021 USD)&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cost per pound (USD)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/98e10b521f939f815b9b81778c72ea70d268ccff5f3be38db828839fbf17faf6.svg" src="_images/98e10b521f939f815b9b81778c72ea70d268ccff5f3be38db828839fbf17faf6.svg" />
</div>
</div>
<p>We can see from the chart that, once adjusted for inflation, cheese was not such a great bargain in the noughties as it appeared from the nominal cost per pound. But the big fall in cheese prices between 2013 and 2017 <em>was</em> a real effect and coincided with the United States’ <a class="reference external" href="https://www.vox.com/2016/10/13/13268980/cheese-glut-united-states">great cheese surplus</a>. Supply and demand work! Of course, the costs are the same in 2021 dollars.</p>
</section>
<section id="feature-engineering">
<h3>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Link to this heading">#</a></h3>
<p>Feature engineering, or feature extraction, is just data science talk for transformations. And, just as with the transformations we’ve seen, you need to take care whether you’re running them as if in real time or not, and whether that matters.</p>
<p>So, is there any real difference between time series econometrics transformations and those found in data science? There isn’t in principle, but in practice the transformations used in data science are a superset of those typically used in econometrics, often because data scientists are trying to squeeze every last drop of predictability out of a time series and don’t mind creating 100s of “features”, aka regressors, to do it.</p>
<p>In the simplest and most naive case, time series feature engineering just involve throwing the kitchen sink at features, ie extracting every metric you can think of: mean, std, max, min, difference of maximum and minimum values, median, median absolute deviation, number of peaks, skewness, kurtosis, etc, etc.</p>
<p>There are a wide range of time series feature extraction packages available in Python. Some examples are <a class="reference external" href="https://tsfresh.readthedocs.io/"><strong>tsfresh</strong></a>, <a class="reference external" href="https://featuretools.alteryx.com/en/stable/getting_started/handling_time.html#Handling-Time"><strong>featuretools</strong></a> (not just time series), <a class="reference external" href="https://tsfel.readthedocs.io/"><strong>tsfel</strong></a>, and Facebook’s <a class="reference external" href="https://facebookresearch.github.io/Kats/"><strong>kats</strong></a> which is very comprehensive but not as lightweight as it claims (it offers forecasting, detection, and time series feature extraction but because it depends on STAN and PyStan, you may have issues using it on Windows—especially on corporate IT systems that are locked down). You can get a sense of the typical features that you can extract from these packages from the default list of <a class="reference external" href="https://tsfel.readthedocs.io/en/latest/descriptions/feature_list.html">features extracted by <strong>tsfresh</strong></a>.</p>
</section>
</section>
<section id="stationarity-and-unit-root-testing">
<h2>Stationarity and Unit Root Testing<a class="headerlink" href="#stationarity-and-unit-root-testing" title="Link to this heading">#</a></h2>
<p>This section is indebted to the excellent documentation of the <a class="reference external" href="https://arch.readthedocs.io/"><strong>arch</strong></a> (Autoregressive Conditional Heteroskedasticity) package. To install <strong>arch</strong> with conda, the conda command is <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">arch-py</span></code>. Conda forge is a community-led effort to increase the number of packages that can be conda installed; <code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">conda-forge</span></code> in the install command tells conda to do an install from the conda-forge repository of packages, while <code class="docutils literal notranslate"><span class="pre">arch-py</span></code> is the package name. If you’re not using conda, the command is <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">arch-py</span></code>. If you like the <strong>arch</strong> package, you can head over to <a class="reference external" href="https://github.com/bashtage/arch">the code repository</a> and give it a star on GitHub.</p>
<p>Remember that a stationary process is a stochastic process whose unconditional joint probability distribution does not change when shifted in time and which, consequently, retains its parameters over time (in contrast to the case with a series with a trend in the mean). The transformations of the previous section give some good ideas as to how to transform stationary series, and we already saw some visual cues with auto- and partial auto-correlations, but here we’ll be looking at formal statistical tests of whether a series is stationary.</p>
<p>As an example dataset to test, we will use the Default premium, the difference between the yields of BAA and AAA rated corporate bonds. Let’s import the <strong>arch</strong> package, <strong>statsmodels</strong> time series functions, and grab <strong>arch</strong>’s built-in default premium data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">arch.data.default</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">arch.unitroot</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADF</span><span class="p">,</span> <span class="n">KPSS</span>

<span class="n">default_data</span> <span class="o">=</span> <span class="n">arch</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">default</span> <span class="o">=</span> <span class="n">default_data</span><span class="o">.</span><span class="n">BAA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">default</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
<span class="n">default</span> <span class="o">=</span> <span class="n">default</span> <span class="o">-</span> <span class="n">default_data</span><span class="o">.</span><span class="n">AAA</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">default</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Default premium (difference in yields, BAA-AAA)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Date
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1919</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.77</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1919</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">02</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.85</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1919</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">03</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.76</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1919</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">04</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.79</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1919</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">05</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.70</span>
Name: default, dtype: float64
</pre>
</div><img alt="_images/16c09b832f921b1738b5978c284b6bee90d2665d5aca648fbaa73f9d138d66f7.svg" src="_images/16c09b832f921b1738b5978c284b6bee90d2665d5aca648fbaa73f9d138d66f7.svg" />
</div>
</div>
<p>Let’s now do some unit root testing.</p>
<section id="augmented-dickey-fuller-test">
<h3>Augmented Dickey-Fuller Test<a class="headerlink" href="#augmented-dickey-fuller-test" title="Link to this heading">#</a></h3>
<p>The Augmented Dickey-Fuller test is the most common unit root test. It is a regression of the first difference of the variable on its lagged level as well as additional lags of the first difference. The null is that the series contains a unit root, and the (one-sided) alternative is that the series is stationary.</p>
<p>By default, the number of lags is selected by minimising the AIC (Akaike information criterion) across a range of lag lengths (which can be set using <code class="docutils literal notranslate"><span class="pre">max_lag</span></code> when initializing the model). Additionally, the basic test includes a constant in the regression.</p>
<p>This is the regression equation:</p>
<div class="math notranslate nohighlight">
\[
\Delta y_t = \alpha + \beta t + \gamma y_{t-1} + \delta_1 \Delta y_{t-1} + \cdots + \delta_{p-1} \Delta y_{t-p+1} + \varepsilon_t,
\]</div>
<p>where <span class="math notranslate nohighlight">\({\displaystyle \alpha }\)</span> is the constant, <span class="math notranslate nohighlight">\({\displaystyle \beta }\)</span> is the coefficient on a time trend and <span class="math notranslate nohighlight">\({\displaystyle p}\)</span> the lag order of the autoregressive process. Imposing the constraints <span class="math notranslate nohighlight">\({\displaystyle \alpha}=0\)</span> and <span class="math notranslate nohighlight">\({\displaystyle \beta } =0\)</span> corresponds to modelling a random walk and using the constraint <span class="math notranslate nohighlight">\({\displaystyle \beta } =0\)</span> corresponds to modelling a random walk with a drift.</p>
<p>These settings correspond to passing a keyword argument, <code class="docutils literal notranslate"><span class="pre">trend</span></code>, with the following options:</p>
<ul class="simple">
<li><p>‘nc’ : No deterministic terms</p></li>
<li><p>‘c’ : Constant only</p></li>
<li><p>‘ct’ : Constant and time trend</p></li>
<li><p>‘ctt’ : Constant, time trend and time-trend squared</p></li>
</ul>
<p>Let’s see the result of the ADF test running on the default data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an ADF object with the default data</span>
<span class="n">adf</span> <span class="o">=</span> <span class="n">ADF</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="c1"># Check the results of the test with the standard settings</span>
<span class="n">adf</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Augmented Dickey-Fuller Results</caption>
<tr>
  <td>Test Statistic</td>    <td>-3.356</td>
</tr>
<tr>
  <td>P-value</td>            <td>0.013</td>
</tr>
<tr>
  <td>Lags</td>                  <td>21</td>
</tr>
</table><br/><br/>Trend: Constant<br/>Critical Values: -3.44 (1%), -2.86 (5%), -2.57 (10%)<br/>Null Hypothesis: The process contains a unit root.<br/>Alternative Hypothesis: The process is weakly stationary.</div></div>
</div>
<p>To change the model specification, create a new object using the relevant keyword arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adf</span> <span class="o">=</span> <span class="n">ADF</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;ct&quot;</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">adf</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Augmented Dickey-Fuller Results</caption>
<tr>
  <td>Test Statistic</td>    <td>-3.786</td>
</tr>
<tr>
  <td>P-value</td>            <td>0.017</td>
</tr>
<tr>
  <td>Lags</td>                   <td>5</td>
</tr>
</table><br/><br/>Trend: Constant and Linear Time Trend<br/>Critical Values: -3.97 (1%), -3.41 (5%), -3.13 (10%)<br/>Null Hypothesis: The process contains a unit root.<br/>Alternative Hypothesis: The process is weakly stationary.</div></div>
</div>
<p>As an ADF test is just a regression, you can get that out of the output too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">adf</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.095</span>
Model:                            OLS   Adj. R-squared:                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.090</span>
Method:                 Least Squares   F-statistic:                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.83</span>
Date:                Wed, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span> Mar <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>   Prob <span style="font-weight: bold">(</span>F-statistic<span style="font-weight: bold">)</span>:           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.30e-22</span>
Time:                        <span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">16:06:06</span>   Log-Likelihood:                 <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">630.15</span>
No. Observations:                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1194</span>   AIC:                            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1244</span>.
Df Residuals:                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1186</span>   BIC:                            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1204</span>.
Df Model:                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.025</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.975</span><span style="font-weight: bold">]</span>
------------------------------------------------------------------------------
Level.L1      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.0248</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.007</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-3.786</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.038</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.012</span>
Diff.L1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.2229</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.029</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.669</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.166</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.280</span>
Diff.L2       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.0525</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.030</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.769</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.077</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.111</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.006</span>
Diff.L3       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.1363</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.029</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-4.642</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.194</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.079</span>
Diff.L4       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.0510</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.030</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.727</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.084</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.109</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.007</span>
Diff.L5        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0440</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.029</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.516</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.130</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.013</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.101</span>
const          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0383</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.013</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.858</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.004</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.012</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.065</span>
trend      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.586e-05</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.29e-05</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.230</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.219</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-4.11e-05</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.43e-06</span>
==============================================================================
Omnibus:                      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">665.553</span>   Durbin-Watson:                   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.000</span>
<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Prob</span><span style="font-weight: bold">(</span>Omnibus<span style="font-weight: bold">)</span>:                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>   Jarque-Bera <span style="font-weight: bold">(</span>JB<span style="font-weight: bold">)</span>:           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">146083.295</span>
Skew:                          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.425</span>   <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Prob</span><span style="font-weight: bold">(</span>JB<span style="font-weight: bold">)</span>:                         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>
Kurtosis:                      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">57.113</span>   Cond. No.                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.70e+03</span>
==============================================================================

Notes:
<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">]</span> Standard Errors assume that the covariance matrix of the errors is correctly specified.
<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span><span style="font-weight: bold">]</span> The condition number is large, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.7e+03</span>. This might indicate that there are
strong multicollinearity or other numerical problems.
</pre>
</div></div>
</div>
</section>
<section id="kpss-testing">
<h3>KPSS Testing<a class="headerlink" href="#kpss-testing" title="Link to this heading">#</a></h3>
<p>The KPSS test differs from ADF in that the <em>null</em> hypothesis is that the time series is a stationary process and the <em>alternative</em> is a unit root.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kpss</span> <span class="o">=</span> <span class="n">KPSS</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="n">kpss</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>KPSS Stationarity Test Results</caption>
<tr>
  <td>Test Statistic</td>     <td>1.088</td>
</tr>
<tr>
  <td>P-value</td>            <td>0.002</td>
</tr>
<tr>
  <td>Lags</td>                  <td>20</td>
</tr>
</table><br/><br/>Trend: Constant<br/>Critical Values: 0.74 (1%), 0.46 (5%), 0.35 (10%)<br/>Null Hypothesis: The process is weakly stationary.<br/>Alternative Hypothesis: The process contains a unit root.</div></div>
</div>
</section>
<section id="other-unit-root-tests">
<h3>Other Unit Root Tests<a class="headerlink" href="#other-unit-root-tests" title="Link to this heading">#</a></h3>
<p><strong>arch</strong> also contains the Phillips-Perron, Zivot-Andrews, and Dickey-Fuller GLS tests; see <a class="reference external" href="https://arch.readthedocs.io/en/latest/unitroot/unitroot_examples.html">here</a> for more information.</p>
</section>
</section>
<section id="seasonality">
<h2>Seasonality<a class="headerlink" href="#seasonality" title="Link to this heading">#</a></h2>
<p>This section is indebted to <a class="reference external" href="http://www.chadfulton.com/">Chad Fulton</a>’s <a class="reference external" href="https://github.com/ChadFulton/sm-notebooks-2021/blob/main/002-seasonal-adjustment.ipynb">notes</a>. Chad is an economist at the Federal Reserve Board of Governors.</p>
<p>Seasonality is when you find recurring, highly predictable changes in time series based on known events. From the point of view of analysis, they’re often not all that interesting and what we <em>really</em> want to know is what’s happening with the underlying series. But to find out, we have to strip out all of that seasonal variation. This is typically done by describing a model that can decompose a series into seasonal and non-seasonal effects.</p>
<p>Seasonal patterns repeat; every quarter, every month, every week, every day, and now—for tech firms—even intra-day seasonal frequencies are a problem econometricians need to worry about.</p>
<p>We will look at some simple and not-as-simple approaches to seasonal adjustment.</p>
<p>We’ll look at the New York Times COVID 19 data for this, with a bit of pre-processing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract: download the data (here, load the CSV directly from the URL)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/nytimes/covid-19-data/master/us.csv&quot;</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
    <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>

<span class="c1"># Transform: add new columns with useful transformations</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;new_cases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;2020-04-01&quot;</span><span class="p">:</span><span class="s2">&quot;2021-02-01&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;new_cases&quot;</span><span class="p">]]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>new_cases</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-04-01</th>
      <td>26930.0</td>
    </tr>
    <tr>
      <th>2020-04-02</th>
      <td>29717.0</td>
    </tr>
    <tr>
      <th>2020-04-03</th>
      <td>32318.0</td>
    </tr>
    <tr>
      <th>2020-04-04</th>
      <td>35099.0</td>
    </tr>
    <tr>
      <th>2020-04-05</th>
      <td>25616.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s plot the data (remember: always plot the data)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_covid_data</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;New COVID-19 cases, U.S.&quot;</span><span class="p">)</span>


<span class="n">plot_covid_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/595171dbb52f99daaf9bb1ec26c67dca30dbd9f261256e85fe30788a4b0743ea.svg" src="_images/595171dbb52f99daaf9bb1ec26c67dca30dbd9f261256e85fe30788a4b0743ea.svg" />
</div>
</div>
<p>Already we can see that there’s a lot of high-frequency variation in these data, with variation that gets stronger over time and some holiday-based outliers. Let’s hone in on a few months to make it easier to see what’s happening:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_covid_data</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;2020-10-01&quot;</span><span class="p">:</span><span class="s2">&quot;2020-12-01&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/76125ce1fe34b19e0411e108114ace1e895fd31f6235440c3b57bdbe6b5c8f4e.svg" src="_images/76125ce1fe34b19e0411e108114ace1e895fd31f6235440c3b57bdbe6b5c8f4e.svg" />
</div>
</div>
<p>Now it’s clear there’s a strong weekly pattern (or <em>every 7th entry</em> in our daily frequency data).</p>
<p>In thinking about a series, an early choice we need to make is whether we think it is multiplicative, and so has a function form like</p>
<div class="math notranslate nohighlight">
\[
y_t = \underbrace{\mu_t}_\text{trend} \times \underbrace{\gamma_t}_\text{seasonal} \times \underbrace{\varepsilon_t}_\text{residual}
\]</div>
<p>or like</p>
<div class="math notranslate nohighlight">
\[
y_t = \underbrace{\mu_t}_\text{trend} + \underbrace{\gamma_t}_\text{seasonal} + \underbrace{\varepsilon_t}_\text{residual}
\]</div>
<p>As the increase in COVID-19 cases is the result of a multiplicative process, the former is more likely here. So the first thing we do is take the log of the series (we could also have used a Box-Cox transform). This will transform our data to the second case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">plot_covid_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2eb39d0dbfb27d6f8240cd85bc6069759f3470ad1fe39312a46861021722f65f.svg" src="_images/2eb39d0dbfb27d6f8240cd85bc6069759f3470ad1fe39312a46861021722f65f.svg" />
</div>
</div>
<p>Now let’s try some methods of seasonal adjustment!</p>
<section id="classical-seasonal-decomposition">
<h3>Classical Seasonal Decomposition<a class="headerlink" href="#classical-seasonal-decomposition" title="Link to this heading">#</a></h3>
<p>This will proceed by estimating the trend component <span class="math notranslate nohighlight">\((\mu_t)\)</span> by applying a moving average (or double moving average, if the seasonal period is an even number), estimating the seasonal component <span class="math notranslate nohighlight">\((\gamma_t)\)</span> by computing the average value of the detrended series <span class="math notranslate nohighlight">\(w_t = y_t - \mu_t\)</span>, and then normalising the seasonal factors (if additive, ensure the means sum to zero, if multiplicative ensure their product is equal to one).</p>
<p>We’ll use <strong>statsmodels</strong>’ <code class="docutils literal notranslate"><span class="pre">seasonal_decompose()</span></code> model for this. It creates an object that retains the following components:</p>
<ul class="simple">
<li><p>trend, the estimated trend component, <span class="math notranslate nohighlight">\(\mu_t\)</span></p></li>
<li><p>seasonal, the estimated seasonal component, <span class="math notranslate nohighlight">\(\gamma_t\)</span></p></li>
<li><p>resid, the residual component, <span class="math notranslate nohighlight">\(\varepsilon_t\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform classical seasonal decomposition</span>
<span class="n">classical_res</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Extract the trend and seasonal components</span>
<span class="n">classical_trend</span> <span class="o">=</span> <span class="n">classical_res</span><span class="o">.</span><span class="n">trend</span>
<span class="n">classical_seasonal</span> <span class="o">=</span> <span class="n">classical_res</span><span class="o">.</span><span class="n">seasonal</span>
<span class="n">classical_resid</span> <span class="o">=</span> <span class="n">classical_res</span><span class="o">.</span><span class="n">resid</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the modified series:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoMinorLocator</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_seasonal_decomp</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;log new cases&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="n">seasonal</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Seasonal&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trend&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;new_cases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">error</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="n">plot_seasonal_decomp</span><span class="p">(</span>
    <span class="n">classical_trend</span><span class="p">,</span> <span class="n">classical_seasonal</span><span class="p">,</span> <span class="n">classical_resid</span><span class="p">,</span> <span class="s2">&quot;Classical Decomposition&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/882fd8d4b908297e027a9a1e83587fb118b3f15ebd909721f9a553c3a34764d9.svg" src="_images/882fd8d4b908297e027a9a1e83587fb118b3f15ebd909721f9a553c3a34764d9.svg" />
</div>
</div>
</section>
<section id="exponential-smoothing">
<h3>Exponential Smoothing<a class="headerlink" href="#exponential-smoothing" title="Link to this heading">#</a></h3>
<p>Exponential smoothing models provide a relatively simple way of estimating both the trend and seasonal factors simultaneously, in a single model. In addition, while the seasonal factors were not able to vary over time in the previous approach, it can in exponential smoothing models.</p>
<p>These models are sometimes referred to as ETS (Error, Trend, and Seasonal) because they can be seen as a generalisation of simple exponential smoothing to time series that contain trends and seasonalities. They have an underlying state space representation. An ETS model is specified by an error type (E; additive or multiplicative), a trend type (T; additive or multiplicative, both damped or undamped, or none), and a seasonality type (S; additive or multiplicative or none).</p>
<p>Here, we will use a simple exponential smoothing method that is assumed to be additive and has a trend. We’ll use a <em>kwarg</em> of <code class="docutils literal notranslate"><span class="pre">initialization_method='concentrated'</span></code>, which estimates the initial values of the level, trend, and seasonal states by “concentrating” them out of the likelihood function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct the exponential smoothing model</span>
<span class="n">ets_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">statespace</span><span class="o">.</span><span class="n">ExponentialSmoothing</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">initialization_method</span><span class="o">=</span><span class="s2">&quot;concentrated&quot;</span>
<span class="p">)</span>

<span class="c1"># Fit the parameters of the model</span>
<span class="n">ets_res</span> <span class="o">=</span> <span class="n">ets_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">ets_seasonal</span> <span class="o">=</span> <span class="n">ets_res</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;seasonal&quot;</span><span class="p">]</span>
<span class="n">ets_trend</span> <span class="o">=</span> <span class="n">ets_res</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span>
<span class="n">ets_resid</span> <span class="o">=</span> <span class="n">ets_res</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_seasonal_decomp</span><span class="p">(</span><span class="n">ets_trend</span><span class="p">,</span> <span class="n">ets_seasonal</span><span class="p">,</span> <span class="n">ets_resid</span><span class="p">,</span> <span class="s2">&quot;Exponential smoothing&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/afa9e29737b555403b1e9820f9a60082a62217400ed744902fc42666034ed22d.svg" src="_images/afa9e29737b555403b1e9820f9a60082a62217400ed744902fc42666034ed22d.svg" />
</div>
</div>
</section>
<section id="stl-or-seasonal-trend-decomposition-based-on-loess">
<h3>STL, or Seasonal-Trend Decomposition Based on Loess<a class="headerlink" href="#stl-or-seasonal-trend-decomposition-based-on-loess" title="Link to this heading">#</a></h3>
<p>A longer description of this approach may be found in section 3.7 of <a class="reference external" href="https://otexts.com/fpp3/stl.html">Hyndman and Athanasopoulos (2021)</a>. Like exponential smoothing models, seasonal factors estimated by STL can vary over time—and indeed, in this case, they do.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct and fit the STL model, using the robust to (some) outliers feature</span>
<span class="n">stl_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">STL</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">stl_res</span> <span class="o">=</span> <span class="n">stl_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">plot_seasonal_decomp</span><span class="p">(</span><span class="n">stl_res</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span> <span class="n">stl_res</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">stl_res</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="s2">&quot;STL&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/789cc3d88ac3a489cb2774db148135816e3cf6a96a94bd823c12115f378b52f3.svg" src="_images/789cc3d88ac3a489cb2774db148135816e3cf6a96a94bd823c12115f378b52f3.svg" />
</div>
</div>
</section>
<section id="unobserved-components-model-aka-structural-time-series-model">
<h3>Unobserved Components Model, aka Structural Time Series Model<a class="headerlink" href="#unobserved-components-model-aka-structural-time-series-model" title="Link to this heading">#</a></h3>
<p>Unobserved components models are extremely flexible, being able to support a variety of trend specifications, dummy variables, seasonal effects that vary over time, support for missing variables, support for autoregressive components, and support for missing observations, and support for exogenous variables. Let’s build a model, albeit a simple one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uc_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">UnobservedComponents</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;smooth trend&quot;</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">uc_res</span> <span class="o">=</span> <span class="n">uc_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">uc_seasonal</span> <span class="o">=</span> <span class="n">uc_res</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;seasonal&quot;</span><span class="p">]</span>
<span class="n">uc_trend</span> <span class="o">=</span> <span class="n">uc_res</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span>
<span class="n">uc_resid</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;new_cases&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">uc_trend</span> <span class="o">-</span> <span class="n">uc_seasonal</span>

<span class="c1"># plot results</span>
<span class="n">plot_seasonal_decomp</span><span class="p">(</span>
    <span class="n">uc_trend</span><span class="p">,</span> <span class="n">uc_seasonal</span><span class="p">,</span> <span class="n">uc_resid</span><span class="p">,</span> <span class="s2">&quot;Unobserved Components (smooth trend)&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f1e6c8fbacbfaa933c39d65202537ffc6031ab63542b9fc93e13d57e27dafb3c.svg" src="_images/f1e6c8fbacbfaa933c39d65202537ffc6031ab63542b9fc93e13d57e27dafb3c.svg" />
</div>
</div>
</section>
<section id="other-seasonal-adjustment-approaches">
<h3>Other Seasonal Adjustment Approaches<a class="headerlink" href="#other-seasonal-adjustment-approaches" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://www.census.gov/data/software/x13as.X-13ARIMA-SEATS.html"><strong>X-13ARIMA-SEATS</strong></a> is a commonly used programme produced by the U.S. Census Bureau. It supports monthly or quarterly, but not daily, data. If you have it installed on your computer, you can use it in <strong>statsmodels</strong> via <code class="docutils literal notranslate"><span class="pre">sm.tsa.x13_arima_analysis</span></code>.</p>
<p><a class="reference external" href="https://github.com/intive-DataScience/tbats"><strong>TBATS</strong></a> is a relatively recent (circa 2011) econometric model that is particularly useful for data that exhibits multiple types of seasonality.</p>
<p>We have only scratched the surface of seasonal adjustment here by looking at trends and simple seasonality. There’re a lot of extra features that can be exploited in the above models, for example adding dummies on dates for which there are events that cause known outliers, or controlling for known anomalies on some specific days. Which leads us neatly on to…</p>
</section>
</section>
<section id="holidays">
<h2>Holidays<a class="headerlink" href="#holidays" title="Link to this heading">#</a></h2>
<p>Everyone enjoys a holiday, except time series econometricians. Holidays mess up those neat models of seasonality we saw in the previous section. Have no fear though, because we are now going to look at some ways to account for holidays.</p>
<p>We’ll be using the <a class="reference external" href="https://workalendar.github.io/workalendar/"><strong>workalendar</strong></a> package which, as ever, you may need to install separately. Workalendar is a Python module that can provide lists of secular and religious holidays for a wide range of countries. (An alternative package is <a class="reference external" href="https://github.com/dr-prodigy/python-holidays"><strong>holidays</strong></a>).) Once we have the right holidays for the right country, we can proceed to control for them.</p>
<p>Here’s an example of grabbing holidays for the United States of America for 2020</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rich</span><span class="w"> </span><span class="kn">import</span> <span class="nb">print</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">workalendar.usa</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnitedStates</span>

<span class="n">cal</span> <span class="o">=</span> <span class="n">UnitedStates</span><span class="p">()</span>
<span class="n">usa_hols_21_22</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">holidays</span><span class="p">(</span><span class="mi">2020</span><span class="p">)</span> <span class="o">+</span> <span class="n">cal</span><span class="o">.</span><span class="n">holidays</span><span class="p">(</span><span class="mi">2021</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">usa_hols_21_22</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'New year'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Birthday of Martin Luther King, Jr.'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">"Washington's Birthday"</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Memorial Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Independence Day (Observed)'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Independence Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Labor Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Columbus Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Veterans Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Thanksgiving Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Christmas Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'New year'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Birthday of Martin Luther King, Jr.'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">"Washington's Birthday"</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Memorial Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Independence Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Independence Day (Observed)'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Labor Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Columbus Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Veterans Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Thanksgiving Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Christmas Day (Observed)'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'Christmas Day'</span><span style="font-weight: bold">)</span>,
    <span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span><span style="font-weight: bold">)</span>, <span style="color: #008000; text-decoration-color: #008000">'New Years Day (Observed)'</span><span style="font-weight: bold">)</span>
<span style="font-weight: bold">]</span>
</pre>
</div></div>
</div>
<p>If you got to grips with types in the <a class="reference internal" href="code-basics.html#code-basics"><span class="std std-ref">Coding Basics</span></a> chapter, you’ll know that this is a list of tuples. The first entry in each tuple is a datetime, the second is the name of the holiday.</p>
<p>As well as this national representation of the USA’s holidays, state level holiday lists are available. To see the available countries, check the github page or use Visual Studio Code’s autocomplete (type <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">workalendar.</span></code> and the country and continent options should appear; type <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">workalendar.europe.</span></code> to see the European countries).</p>
<p>Let’s put these holidays into a dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">usa_hols_21_22</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;holiday&quot;</span><span class="p">])</span>
<span class="n">df_hols</span> <span class="o">=</span> <span class="n">df_hols</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]))</span>
<span class="n">df_hols</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>holiday</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2020-01-01</td>
      <td>New year</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2020-01-20</td>
      <td>Birthday of Martin Luther King, Jr.</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-02-17</td>
      <td>Washington's Birthday</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2020-05-25</td>
      <td>Memorial Day</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2021-11-25</td>
      <td>Thanksgiving Day</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2021-12-24</td>
      <td>Christmas Day (Observed)</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2021-12-25</td>
      <td>Christmas Day</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2021-12-31</td>
      <td>New Years Day (Observed)</td>
    </tr>
  </tbody>
</table>
<p>24 rows × 2 columns</p>
</div></div></div>
</div>
<p>How might we be able to use this in analysis? Let’s merge it with our COVID-19 data. Note that we’re only interested in holidays that fall within the date range of our COVID data so when we do the merge, we use <code class="docutils literal notranslate"><span class="pre">how=&quot;right&quot;</span></code>. We’re also resetting the index so that <code class="docutils literal notranslate"><span class="pre">date</span></code> appears as column in <em>both</em> dataframes (and making the <code class="docutils literal notranslate"><span class="pre">date</span></code> the index again afterwards with <code class="docutils literal notranslate"><span class="pre">set_index()</span></code>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_hols</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">19</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>holiday</th>
      <th>new_cases</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-01-14</th>
      <td>NaN</td>
      <td>12.386401</td>
    </tr>
    <tr>
      <th>2021-01-15</th>
      <td>NaN</td>
      <td>12.387782</td>
    </tr>
    <tr>
      <th>2021-01-16</th>
      <td>NaN</td>
      <td>12.216978</td>
    </tr>
    <tr>
      <th>2021-01-17</th>
      <td>NaN</td>
      <td>12.044107</td>
    </tr>
    <tr>
      <th>2021-01-18</th>
      <td>Birthday of Martin Luther King, Jr.</td>
      <td>11.857458</td>
    </tr>
    <tr>
      <th>2021-01-19</th>
      <td>NaN</td>
      <td>12.138564</td>
    </tr>
    <tr>
      <th>2021-01-20</th>
      <td>NaN</td>
      <td>12.130745</td>
    </tr>
    <tr>
      <th>2021-01-21</th>
      <td>NaN</td>
      <td>12.157313</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s create a new column with a dummy for when a date is a holiday:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;holiday&quot;</span><span class="p">]),</span> <span class="s2">&quot;dummy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">19</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>holiday</th>
      <th>new_cases</th>
      <th>dummy</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-01-14</th>
      <td>NaN</td>
      <td>12.386401</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2021-01-15</th>
      <td>NaN</td>
      <td>12.387782</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2021-01-16</th>
      <td>NaN</td>
      <td>12.216978</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2021-01-17</th>
      <td>NaN</td>
      <td>12.044107</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2021-01-18</th>
      <td>Birthday of Martin Luther King, Jr.</td>
      <td>11.857458</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2021-01-19</th>
      <td>NaN</td>
      <td>12.138564</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2021-01-20</th>
      <td>NaN</td>
      <td>12.130745</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2021-01-21</th>
      <td>NaN</td>
      <td>12.157313</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we have a dataset with new cases by date and with a dummy indicator for whether a period is a holiday or not. A typical way of including the effect of holidays in a regression would be to use a model like the following:</p>
<div class="math notranslate nohighlight">
\[
y_t = \mu_t + \gamma_t + \underbrace{\beta_1 x_{1t}}_\text{Thanksgiving} + \underbrace{\beta_2 x_{2t}}_\text{Christmas} + \underbrace{\beta_3 x_{3t}}_\text{New Year's Day} + \varepsilon_t
\]</div>
<p>This is very similar to the seasonal only model we saw in the previous section, it just has a small number of dedicated dummy variables to capture the effects of a holiday. To create the design matrix for a regression that directly made use of these dummy variables, we could use <strong>pandas</strong> get dummies function (use <code class="docutils literal notranslate"><span class="pre">drop_first=True</span></code> if you have a constant term and want to avoid the dummy variable trap):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">40</span><span class="p">:</span><span class="o">-</span><span class="mi">35</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>new_cases</th>
      <th>dummy</th>
      <th>dummy_Birthday of Martin Luther King, Jr.</th>
      <th>dummy_Christmas Day</th>
      <th>dummy_Columbus Day</th>
      <th>dummy_Independence Day</th>
      <th>dummy_Independence Day (Observed)</th>
      <th>dummy_Labor Day</th>
      <th>dummy_Memorial Day</th>
      <th>dummy_New year</th>
      <th>dummy_Thanksgiving Day</th>
      <th>dummy_Veterans Day</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-12-24</th>
      <td>12.173090</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2020-12-25</th>
      <td>11.522192</td>
      <td>1</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2020-12-26</th>
      <td>12.287012</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2020-12-27</th>
      <td>11.932221</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2020-12-28</th>
      <td>12.149555</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="seasonal-and-holiday-adjustment">
<h3>Seasonal and Holiday Adjustment<a class="headerlink" href="#seasonal-and-holiday-adjustment" title="Link to this heading">#</a></h3>
<p>Although directly carrying out regressions with dummy variables is one way to control for holidays, some models offer an easier alternative and now we’re going to take an example from the previous section, on seasonal adjustment, to show how.</p>
<p>We’ll use the unobserved components model because that allows us to pass in an <code class="docutils literal notranslate"><span class="pre">exog</span></code> series full of seasonal dummy variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uc_hols_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">UnobservedComponents</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;new_cases&quot;</span><span class="p">],</span> <span class="s2">&quot;smooth trend&quot;</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">uc_hols</span> <span class="o">=</span> <span class="n">uc_hols_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">uc_hols_seasonal</span> <span class="o">=</span> <span class="n">uc_hols</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;seasonal&quot;</span><span class="p">]</span>
<span class="n">uc_hols_trend</span> <span class="o">=</span> <span class="n">uc_hols</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span>
<span class="n">uc_hols_resid</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;new_cases&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">uc_hols_trend</span> <span class="o">-</span> <span class="n">uc_hols_seasonal</span>

<span class="c1"># plot results</span>
<span class="n">plot_seasonal_decomp</span><span class="p">(</span>
    <span class="n">uc_hols_trend</span><span class="p">,</span>
    <span class="n">uc_hols_seasonal</span><span class="p">,</span>
    <span class="n">uc_hols_resid</span><span class="p">,</span>
    <span class="s2">&quot;Unobserved Components (smooth trend)&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5649e45788e913c44abdcdda6aaa0c646c1dca5998b8b77f3d805fd485adecb9.svg" src="_images/5649e45788e913c44abdcdda6aaa0c646c1dca5998b8b77f3d805fd485adecb9.svg" />
</div>
</div>
<p>Did this model do better than the same unobserved components model without the dummy indicators for holidays? We can test that directly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;The error was </span><span class="si">{</span><span class="p">(</span><span class="n">uc_hols_resid</span><span class="o">/</span><span class="n">uc_resid</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% of the model without holidays.&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">The error was <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">85</span>% of the model without holidays.
</pre>
</div></div>
</div>
<p>So, indeed, adding holidays as exogenous factors created a <em>reduction</em> in error in the model.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Explore how consistent the reduction in error is. You may want to plot some exploratory charts, including a <code class="docutils literal notranslate"><span class="pre">hist()</span></code>.</p>
</div>
</section>
</section>
<section id="granger-causality">
<h2>Granger Causality<a class="headerlink" href="#granger-causality" title="Link to this heading">#</a></h2>
<p>Granger causality is not causality at all; you can find out more about that in the Chapter on <a class="reference internal" href="econmt-causal-inference.html#econmet-causal-inference"><span class="std std-ref">Causal Inference</span></a>! What this test really tells us is whether two series are temporally related, and if one series is useful for predicting another. More formally, a time series <span class="math notranslate nohighlight">\(x_t\)</span> Granger-causes another time series <span class="math notranslate nohighlight">\(y_t\)</span> if predictions of the value of <span class="math notranslate nohighlight">\(y_t\)</span> based on its own past values <em>and</em> on the past values of <span class="math notranslate nohighlight">\(x\)</span> are better than predictions of <span class="math notranslate nohighlight">\(y\)</span> based only on <span class="math notranslate nohighlight">\(y\)</span>’s own past values.</p>
<p>The null for a Granger causality test is that <span class="math notranslate nohighlight">\(x\)</span> does not provide additional value for predicting <span class="math notranslate nohighlight">\(y\)</span>.</p>
<p><strong>statsmodels</strong> provides a convenient method for performing Granger causality tests within its <code class="docutils literal notranslate"><span class="pre">tsa.stattools</span></code> module. The test asks whether the time series in the second column Granger causes the time series in the first column, ie use it as <code class="docutils literal notranslate"><span class="pre">test(caused,</span> <span class="pre">causing)</span></code>.</p>
<p>Let’s load some macroeconomic data to run the test on:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tsa.stattools</span><span class="w"> </span><span class="kn">import</span> <span class="n">grangercausalitytests</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">macrodata</span><span class="o">.</span><span class="n">load_pandas</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;realgdp&quot;</span><span class="p">,</span> <span class="s2">&quot;realcons&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>realgdp</th>
      <th>realcons</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.025256</td>
      <td>0.015404</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.001192</td>
      <td>0.010440</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.003501</td>
      <td>0.001085</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.022438</td>
      <td>0.009580</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.004674</td>
      <td>0.012652</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>And now the test of whether (growth in) real consumption Granger causes (growth in) real GDP. We will use 1 lag. The Granger test actually produces a set of statistics and returns a dictionary that contains all of them (it’s first key is the lag).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">granger_results</span> <span class="o">=</span> <span class="n">grangercausalitytests</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">maxlag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Granger Causality
number of lags (no zero) 1
ssr based F test:         F=28.7248 , p=0.0000  , df_denom=198, df_num=1
ssr based chi2 test:   chi2=29.1600 , p=0.0000  , df=1
likelihood ratio test: chi2=27.2295 , p=0.0000  , df=1
parameter F test:         F=28.7248 , p=0.0000  , df_denom=198, df_num=1
</pre></div>
</div>
</div>
</div>
<p>In this case, there’s an emphatic relationship between the series. When choosing lags, note that there is a trade-off between bias and power. With too few lags the test may be biased because of residual auto-correlation. Too many, and you risk spurious rejections of the null because of random correlations. For more on how to properly choose lags and perform this test, look at the <a class="reference external" href="https://davegiles.blogspot.com/2011/04/testing-for-granger-causality.html">entry on Granger tests on Dave Giles’ blog</a>.</p>
</section>
<section id="breaks-and-changepoint-detection">
<h2>Breaks and Changepoint Detection<a class="headerlink" href="#breaks-and-changepoint-detection" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>Everything you say to me<br />
Takes me one step closer to the edge<br />
And I’m about to break</p>
</div></blockquote>
<p>—— Linkin Park, Hybrid Theory (2000); also, time series</p>
<p>COVID-19 has brought a period of extreme structural change in the economy, and in time series related to the economy. It is useful to have tests for when time series have fundamentally changed due to a <em>break</em> or <em>changepoint</em>. What do we mean by fundamentally? The <em>moments</em> have changed; the mean, the variance, and so on.</p>
<p>Note that this is different from an anomaly, which is an outlier. A break suggests a change that has occurred between the before times and the after times; an anomaly is an observation that seems not to fit an ongoing pattern.</p>
<p>Perhaps the most widely used changepoint detection package is <a class="reference external" href="https://github.com/deepcharles/ruptures"><strong>ruptures</strong></a>. Let’s see if we can detect some distinct changes in the growth of the UK’s productivity (measured per hour).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">series_id</span> <span class="o">=</span> <span class="s2">&quot;prdy&quot;</span>  <span class="c1"># case sensitive</span>
<span class="n">timeseries_id</span> <span class="o">=</span> <span class="s2">&quot;lzvc&quot;</span>


<span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.beta.ons.gov.uk/v1/data?uri=/employmentandlabourmarket/peopleinwork/labourproductivity/timeseries/</span><span class="si">{</span><span class="n">timeseries_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">series_id</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1"># Get the data from the ONS API:</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;quarters&quot;</span><span class="p">]))</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">]]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Output per hour: growth&quot;</span><span class="p">})</span>
<span class="c1"># Convert 1959 Q3 format to a proper datetime, eg 1959-09-30</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m&quot;</span>
<span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Output per hour: growth</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-03-31</th>
      <td>0.5</td>
    </tr>
    <tr>
      <th>1972-06-30</th>
      <td>1.2</td>
    </tr>
    <tr>
      <th>1972-09-30</th>
      <td>1.8</td>
    </tr>
    <tr>
      <th>1972-12-31</th>
      <td>2.4</td>
    </tr>
    <tr>
      <th>1973-03-31</th>
      <td>2.5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>ruptures</strong> has many offline changepoint detection methods, some of which require the user to supply the number of breaks. Let’s look at a fully <em>unsupervised</em> algorithm, Pelt, which stands for Penalised change point detection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cycle</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ruptures</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rpt</span>

<span class="c1"># detection</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">rpt</span><span class="o">.</span><span class="n">Pelt</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;rbf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Output per hour: growth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">break_indices</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_break_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">brk_pts</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span>
    <span class="c1"># change brk_pts results to index positions:</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">brk_pts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="p">)</span>
    <span class="c1"># change positions to pairs of positions</span>
    <span class="n">pairs_pos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
    <span class="c1"># iterate over pairs of positions:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs_pos</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">))</span>
        <span class="c1"># vertical lines to mark the break points</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot; (changepoint detection)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plot_break_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;Output per hour: growth&quot;</span><span class="p">,</span> <span class="n">break_indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7671f624582a93ce4c63c12cce4dc2fb78b6877e474bd568a381f6ca251800da.svg" src="_images/7671f624582a93ce4c63c12cce4dc2fb78b6877e474bd568a381f6ca251800da.svg" />
</div>
</div>
<p>This looks plausible, but you can get very different results depending on the value you use for the penalty (<code class="docutils literal notranslate"><span class="pre">pen=</span></code>)</p>
<p>We can manufacture a clearer example by creating some fake data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate signal</span>
<span class="n">n_samples</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span>
<span class="n">n_bkps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of breakpoints</span>
<span class="n">signal</span><span class="p">,</span> <span class="n">bkps</span> <span class="o">=</span> <span class="n">rpt</span><span class="o">.</span><span class="n">pw_constant</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">n_bkps</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_for_prng</span>
<span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;synthetic data&quot;</span><span class="p">])</span>

<span class="c1"># detection</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">rpt</span><span class="o">.</span><span class="n">Pelt</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;rbf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s2">&quot;synthetic data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">break_indices</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">plot_break_points</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;synthetic data&quot;</span><span class="p">,</span> <span class="n">break_indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5ac91aee67d3906020797c62416d188261cd5694bee41794be5eefa226a26f35.svg" src="_images/5ac91aee67d3906020797c62416d188261cd5694bee41794be5eefa226a26f35.svg" />
</div>
</div>
<section id="see-also">
<h3>See Also<a class="headerlink" href="#see-also" title="Link to this heading">#</a></h3>
<p>Although <strong>ruptures</strong> contains a number of changepoint detection algorithms, it’s not the only package around. Facebook has developed both <a class="reference external" href="https://facebook.github.io/prophet/"><strong>prophet</strong></a>, which is a Bayesian auto-time series prediction package that comes with break point detection, and <a class="reference external" href="https://facebookresearch.github.io/Kats/"><strong>kats</strong></a>, which uses a cumulative sum-based changepoint detection algorithm. For the matrix profile approach, see <a class="reference external" href="https://github.com/target/matrixprofile-ts"><strong>matrixprofile-ts</strong></a> and <a class="reference external" href="https://stumpy.readthedocs.io/en/latest/"><strong>stumpy</strong></a>. The <a class="reference external" href="https://schuetzgroup.github.io/sdt-python/changepoint.html"><strong>sdt</strong></a> library, while ostensibly for fluorescence microscopy, provides online and offline Bayesian changepoint detection.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="time-intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction to Time</p>
      </div>
    </a>
    <a class="right-next"
       href="time-fcasts-env.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Forecasting Exercises</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-time-series-with-pandas">Introducing Time Series with <strong>pandas</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-and-using-time-series">Creating and Using Time Series</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#datetime-offsets">Datetime Offsets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-dt-accessor">The <code class="docutils literal notranslate"><span class="pre">.dt</span></code> accessor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-datetime-index-and-setting-the-frequency">Creating a datetime index and setting the frequency</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-quick-time-series-plots">Making Quick Time Series Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling-rolling-and-shifting">Resampling, Rolling, and Shifting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling">Resampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rolling-window-functions">Rolling Window Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shifting">Shifting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correlations">Correlations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autocorrelation">Autocorrelation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#correlations-with-other-series">Correlations with Other Series</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transformations">Transformations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-transformations">Mathematical Transformations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-box-cox-transform">The Box-Cox Transform</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjusting-for-inflation">Adjusting for Inflation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature Engineering</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stationarity-and-unit-root-testing">Stationarity and Unit Root Testing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#augmented-dickey-fuller-test">Augmented Dickey-Fuller Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kpss-testing">KPSS Testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-unit-root-tests">Other Unit Root Tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality">Seasonality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classical-seasonal-decomposition">Classical Seasonal Decomposition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exponential-smoothing">Exponential Smoothing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stl-or-seasonal-trend-decomposition-based-on-loess">STL, or Seasonal-Trend Decomposition Based on Loess</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unobserved-components-model-aka-structural-time-series-model">Unobserved Components Model, aka Structural Time Series Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-seasonal-adjustment-approaches">Other Seasonal Adjustment Approaches</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#holidays">Holidays</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-and-holiday-adjustment">Seasonal and Holiday Adjustment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#granger-causality">Granger Causality</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#breaks-and-changepoint-detection">Breaks and Changepoint Detection</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Arthur Turrell
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  This book is available under an MIT license.
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>